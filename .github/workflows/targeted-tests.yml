name: Targeted Day Tests

on:
    pull_request:
        paths:
            - 'src/**/day**/**'
            - 'test/**/day**.test.ts'
            - '.github/workflows/**'

jobs:
    targeted-tests:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
            - name: Enable Corepack and activate Yarn 4
              run: |
                  corepack enable
                  corepack prepare yarn@4.5.1 --activate
            - name: Install dependencies
              run: yarn install --immutable
            - name: Determine changed days
              run: |
                  git fetch --no-tags --depth=1 origin ${{ github.event.pull_request.base.ref }}
                  git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.sha }} | grep -oE 'src/[0-9]{4}/day[0-9]{2}' | sort -u > days.txt || true
            - name: Run targeted tests
              run: |
                  if [ -s days.txt ]; then
                    while read d; do
                      day=$(basename "$d")
                      echo "Running tests for $d (day arg: $day)"
                      yarn test ${day}
                    done < days.txt
                  else
                    echo "No day-specific changes detected; skipping targeted tests"
                  fi
